# JWT è®¤è¯ç³»ç»Ÿå®ç°æ€è·¯å’Œåº•å±‚é€»è¾‘è¯¦è§£

## ğŸ“‹ ç›®å½•

1. [æ ¸å¿ƒæ€æƒ³](#æ ¸å¿ƒæ€æƒ³)
2. [åº•å±‚å·¥ä½œåŸç†](#åº•å±‚å·¥ä½œåŸç†)
3. [æ¨¡å—ä¹‹é—´çš„å…³è”](#æ¨¡å—ä¹‹é—´çš„å…³è”)
4. [ä»£ç å®ç°ç»†èŠ‚](#ä»£ç å®ç°ç»†èŠ‚)
5. [å®‰å…¨æ€§ä¿éšœ](#å®‰å…¨æ€§ä¿éšœ)
6. [Redis è¿›é˜¶æ–¹æ¡ˆ](#redis-è¿›é˜¶æ–¹æ¡ˆ)

---

## ğŸ’¡ æ ¸å¿ƒæ€æƒ³

### ä¼ ç»Ÿ Session è®¤è¯ vs JWT è®¤è¯

#### ä¼ ç»Ÿ Session æ–¹å¼

```
ç”¨æˆ·ç™»å½•
  â†“
æœåŠ¡å™¨åˆ›å»º Sessionï¼Œå­˜å‚¨åœ¨æœåŠ¡å™¨å†…å­˜/æ•°æ®åº“
  â†“
è¿”å› Session ID ç»™å®¢æˆ·ç«¯ï¼ˆCookieï¼‰
  â†“
å®¢æˆ·ç«¯æ¯æ¬¡è¯·æ±‚æºå¸¦ Session ID
  â†“
æœåŠ¡å™¨æŸ¥è¯¢ Sessionï¼ŒéªŒè¯èº«ä»½
```

**é—®é¢˜**ï¼š
- éœ€è¦æœåŠ¡å™¨å­˜å‚¨ Sessionï¼ˆå ç”¨å†…å­˜/æ•°æ®åº“ï¼‰
- åˆ†å¸ƒå¼ç³»ç»Ÿéœ€è¦ Session å…±äº«
- æœåŠ¡å™¨é‡å¯ Session ä¸¢å¤±

#### JWT æ–¹å¼

```
ç”¨æˆ·ç™»å½•
  â†“
æœåŠ¡å™¨ç”Ÿæˆ JWT Tokenï¼ˆä¸å­˜å‚¨ï¼‰
  â†“
è¿”å› Token ç»™å®¢æˆ·ç«¯
  â†“
å®¢æˆ·ç«¯æ¯æ¬¡è¯·æ±‚æºå¸¦ Token
  â†“
æœåŠ¡å™¨éªŒè¯ Token ç­¾åï¼ˆæ— éœ€æŸ¥è¯¢æ•°æ®åº“ï¼‰
```

**ä¼˜åŠ¿**ï¼š
- **æ— çŠ¶æ€**ï¼šæœåŠ¡å™¨ä¸éœ€è¦å­˜å‚¨ Token
- **å¯æ‰©å±•**ï¼šå¤©ç„¶æ”¯æŒåˆ†å¸ƒå¼
- **é«˜æ€§èƒ½**ï¼šéªŒè¯åªéœ€è®¡ç®—ç­¾åï¼Œæ— éœ€æŸ¥æ•°æ®åº“

---

## ğŸ” åº•å±‚å·¥ä½œåŸç†

### 1. JWT Token çš„æœ¬è´¨

JWT æ˜¯ä¸€ä¸ª**ç»è¿‡ç­¾åçš„ JSON æ•°æ®åŒ…**ï¼Œç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxMjMsImV4cCI6MTcwNDA2NzIwMH0.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Part 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Part 2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Part 3 â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      Header (Base64)                Payload (Base64)               Signature (HMAC-SHA256)
```

#### Part 1: Headerï¼ˆå¤´éƒ¨ï¼‰

```json
{
  "alg": "HS256",     // ä½¿ç”¨ HMAC-SHA256 ç®—æ³•
  "typ": "JWT"        // ç±»å‹æ˜¯ JWT
}
```

ç¼–ç ï¼š`Base64UrlEncode({"alg":"HS256","typ":"JWT"})`

#### Part 2: Payloadï¼ˆè´Ÿè½½ / æ•°æ®éƒ¨åˆ†ï¼‰

```json
{
  "user_id": 123,           // è‡ªå®šä¹‰å­—æ®µï¼šç”¨æˆ· ID
  "exp": 1704067200,        // æ ‡å‡†å­—æ®µï¼šè¿‡æœŸæ—¶é—´ï¼ˆUnix æ—¶é—´æˆ³ï¼‰
  "iat": 1704063600,        // æ ‡å‡†å­—æ®µï¼šç­¾å‘æ—¶é—´
  "nbf": 1704063600         // æ ‡å‡†å­—æ®µï¼šç”Ÿæ•ˆæ—¶é—´ï¼ˆä¸æ—©äºï¼‰
}
```

ç¼–ç ï¼š`Base64UrlEncode(payload_json)`

#### Part 3: Signatureï¼ˆç­¾åï¼‰

```javascript
signature = HMACSHA256(
  base64UrlEncode(header) + "." + base64UrlEncode(payload),
  secret_key  // åªæœ‰æœåŠ¡å™¨çŸ¥é“çš„å¯†é’¥
)
```

**å…³é”®ç‚¹**ï¼š
- Header å’Œ Payload åªæ˜¯ Base64 ç¼–ç ï¼Œ**ä»»ä½•äººéƒ½èƒ½è§£ç æŸ¥çœ‹**
- ä½† Signature éœ€è¦ `secret_key` æ‰èƒ½ç”Ÿæˆ
- ç¯¡æ”¹ Payload ä¼šå¯¼è‡´ç­¾åä¸åŒ¹é…ï¼ŒéªŒè¯å¤±è´¥

---

### 2. ç­¾åéªŒè¯çš„æ•°å­¦åŸç†

#### HMAC-SHA256 ç®—æ³•

```
HMAC(message, secret) = hash((secret âŠ• opad) || hash((secret âŠ• ipad) || message))
```

**ç‰¹æ€§**ï¼š
1. **å•å‘æ€§**ï¼šæ— æ³•ä» hash å€¼åæ¨åŸå§‹æ•°æ®
2. **é›ªå´©æ•ˆåº”**ï¼šè¾“å…¥å¾®å°å˜åŒ–å¯¼è‡´è¾“å‡ºå®Œå…¨ä¸åŒ
3. **ç¡®å®šæ€§**ï¼šç›¸åŒè¾“å…¥æ€»æ˜¯äº§ç”Ÿç›¸åŒè¾“å‡º

#### å®é™…éªŒè¯è¿‡ç¨‹

```python
# æœåŠ¡ç«¯ç”Ÿæˆ Token
original_signature = HMAC_SHA256(
    "header.payload",
    "my_secret_key_12345"
)
# ç»“æœ: SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c

# æ”»å‡»è€…ç¯¡æ”¹ Payload
tampered_payload = base64encode('{"user_id":999,"exp":1704067200}')
token = f"header.{tampered_payload}.{original_signature}"

# æœåŠ¡ç«¯éªŒè¯
computed_signature = HMAC_SHA256(
    f"header.{tampered_payload}",
    "my_secret_key_12345"
)
# ç»“æœ: å®Œå…¨ä¸åŒçš„å€¼ï¼

# æ¯”è¾ƒ
computed_signature != original_signature
# éªŒè¯å¤±è´¥ï¼æ‹’ç»è¯·æ±‚
```

**ä¸ºä»€ä¹ˆæ”»å‡»è€…æ— æ³•ä¼ªé€ ï¼Ÿ**
- æ”»å‡»è€…ä¸çŸ¥é“ `secret_key`
- æ²¡æœ‰å¯†é’¥ï¼Œæ— æ³•è®¡ç®—æ­£ç¡®çš„ç­¾å
- å³ä½¿å¤åˆ¶äº†æ—§ç­¾åï¼Œä¿®æ”¹ Payload åç­¾åå°±ä¸åŒ¹é…äº†

---

### 3. bcrypt å¯†ç åŠ å¯†åŸç†

#### ä¸ºä»€ä¹ˆä¸ç”¨ MD5/SHA1ï¼Ÿ

```python
# MD5/SHA1 çš„é—®é¢˜
password = "123456"
hash1 = MD5("123456")  # e10adc3949ba59abbe56e057f20f883e
hash2 = MD5("123456")  # e10adc3949ba59abbe56e057f20f883e
# ç›¸åŒå¯†ç çš„ hash æ€»æ˜¯ä¸€æ ·ï¼

# æ”»å‡»è€…å¯ä»¥é¢„å…ˆè®¡ç®—å¸¸è§å¯†ç çš„ hashï¼ˆå½©è™¹è¡¨æ”»å‡»ï¼‰
rainbow_table = {
  "e10adc3949ba59abbe56e057f20f883e": "123456",
  "5f4dcc3b5aa765d61d8327deb882cf99": "password",
  ...
}
```

#### bcrypt çš„è§£å†³æ–¹æ¡ˆ

```python
# bcrypt è‡ªåŠ¨åŠ ç›
hash1 = bcrypt("123456")  
# $2a$10$N9qo8uLOickgx2ZMRZoMyeAbc123...

hash2 = bcrypt("123456")  
# $2a$10$X7fH2kQmLpGnVxYtBnOpZeXyz789...

# ç›¸åŒå¯†ç ï¼Œæ¯æ¬¡ hash éƒ½ä¸åŒï¼
```

#### bcrypt Hash ç»“æ„

```
$2a$10$N9qo8uLOickgx2ZMRZoMye$abcdefghijklmnopqrstuvwxyz123456
 â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€ salt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ hash â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 â”‚  â””â”€â”€ cost (2^10 = 1024 æ¬¡è¿­ä»£)
 â””â”€â”€ ç®—æ³•ç‰ˆæœ¬
```

**éªŒè¯æµç¨‹**ï¼š

```python
# æ³¨å†Œæ—¶
password = "mypassword"
salt = generate_random_salt()  # éšæœºç›
hash = bcrypt_hash(password, salt, cost=10)
# å­˜å‚¨åˆ°æ•°æ®åº“: $2a$10$salt$hash

# ç™»å½•æ—¶
input_password = "mypassword"
stored_hash = "$2a$10$salt$hash"

# ä» stored_hash ä¸­æå– salt
extracted_salt = parse_salt(stored_hash)

# ç”¨ç›¸åŒçš„ salt å¯¹è¾“å…¥å¯†ç åŠ å¯†
computed_hash = bcrypt_hash(input_password, extracted_salt, cost=10)

# æ¯”è¾ƒ
if computed_hash == stored_hash:
    print("å¯†ç æ­£ç¡®")
```

**å®‰å…¨ç‰¹æ€§**ï¼š
1. **ç›éšæœºåŒ–**ï¼šæ¯ä¸ªå¯†ç çš„ç›éƒ½ä¸åŒï¼Œé˜²æ­¢å½©è™¹è¡¨æ”»å‡»
2. **æ…¢å“ˆå¸Œ**ï¼šcost=10 æ„å‘³ç€è®¡ç®— 2^10 = 1024 æ¬¡ï¼Œæš´åŠ›ç ´è§£éå¸¸æ…¢
3. **å¯è°ƒæ•´**ï¼šéšç€ç¡¬ä»¶æ€§èƒ½æå‡ï¼Œå¯ä»¥å¢åŠ  cost å€¼

---

## ğŸ”— æ¨¡å—ä¹‹é—´çš„å…³è”

### å®Œæ•´çš„è¯·æ±‚å¤„ç†æµç¨‹

#### 1. ç”¨æˆ·ç™»å½•æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·ç«¯     â”‚ å‘é€ {username, password}
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ POST /api/auth/login
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  main.go                                    â”‚
â”‚  - å¯åŠ¨ Gin æœåŠ¡å™¨                          â”‚
â”‚  - æ³¨å†Œè·¯ç”±                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  routes/routes.go                           â”‚
â”‚  - è°ƒç”¨ SetupAuthRoutes()                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  routes/auth_routes.go                      â”‚
â”‚  - è·¯ç”±æ³¨å†Œ                                 â”‚
â”‚  - POST /api/auth/login â†’ handlers.Login   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  handlers/auth_handlers.go                  â”‚
â”‚  Login() å‡½æ•°:                              â”‚
â”‚    1. ç»‘å®šè¯·æ±‚å‚æ•°                          â”‚
â”‚    2. æŸ¥è¯¢æ•°æ®åº“                            â”‚
â”‚    3. è°ƒç”¨ util.CheckPassword()            â”‚
â”‚    4. è°ƒç”¨ util.GenerateToken()            â”‚
â”‚    5. è¿”å› Token                            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                 â”‚                  â”‚
       â†“                 â†“                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ config/     â”‚  â”‚ util/        â”‚  â”‚ util/         â”‚
â”‚ db.go       â”‚  â”‚ password_    â”‚  â”‚ jwt_util.go   â”‚
â”‚             â”‚  â”‚ util.go      â”‚  â”‚               â”‚
â”‚ - æ•°æ®åº“    â”‚  â”‚              â”‚  â”‚               â”‚
â”‚   è¿æ¥      â”‚  â”‚ - éªŒè¯å¯†ç    â”‚  â”‚ - ç”Ÿæˆ Token  â”‚
â”‚             â”‚  â”‚   (bcrypt)   â”‚  â”‚   (JWT)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                 â”‚                  â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â†“
                   è¿”å› Token
                         â”‚
                         â†“
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚   å®¢æˆ·ç«¯      â”‚
                 â”‚ å­˜å‚¨ Token    â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2. å—ä¿æŠ¤æ¥å£è®¿é—®æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·ç«¯     â”‚ Header: Authorization Bearer xxx
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ GET /api/auth/me
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  routes/auth_routes.go                      â”‚
â”‚  å—ä¿æŠ¤è·¯ç”±ç»„:                              â”‚
â”‚    protected.Use(AuthMiddleware())          â”‚
â”‚    protected.GET("/me", handlers.GetMe)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  middleware/auth_middleware.go              â”‚
â”‚  AuthMiddleware() ä¸­é—´ä»¶:                   â”‚
â”‚    1. ä» Header/Cookie æå– Token          â”‚
â”‚    2. è°ƒç”¨ util.ParseToken() éªŒè¯          â”‚
â”‚    3. æå– user_id                          â”‚
â”‚    4. å­˜å…¥ä¸Šä¸‹æ–‡ c.Set("user_id", id)      â”‚
â”‚    5. è°ƒç”¨ c.Next() ç»§ç»­                    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  util/jwt_util.go                           â”‚
â”‚  ParseToken() å‡½æ•°:                         â”‚
â”‚    1. åˆ†ç¦» Header.Payload.Signature        â”‚
â”‚    2. Base64 è§£ç  Header å’Œ Payload        â”‚
â”‚    3. ç”¨ secret é‡æ–°è®¡ç®—ç­¾å               â”‚
â”‚    4. æ¯”è¾ƒç­¾åæ˜¯å¦ä¸€è‡´                     â”‚
â”‚    5. æ£€æŸ¥ exp æ˜¯å¦è¿‡æœŸ                    â”‚
â”‚    6. è¿”å› Claims (å« user_id)             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ éªŒè¯æˆåŠŸ
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  handlers/auth_handlers.go                  â”‚
â”‚  GetCurrentUser() å‡½æ•°:                     â”‚
â”‚    1. ä»ä¸Šä¸‹æ–‡è·å– user_id                 â”‚
â”‚    2. æŸ¥è¯¢æ•°æ®åº“                            â”‚
â”‚    3. è¿”å›ç”¨æˆ·ä¿¡æ¯                          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·ç«¯     â”‚ æ”¶åˆ°ç”¨æˆ·ä¿¡æ¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¾èµ–å…³ç³»å›¾

```
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   main.go    â”‚
                        â”‚  ç¨‹åºå…¥å£    â”‚
                        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  config/      â”‚             â”‚  routes/       â”‚
        â”‚  db.go        â”‚             â”‚  routes.go     â”‚
        â”‚  - æ•°æ®åº“è¿æ¥ â”‚             â”‚  - è·¯ç”±æ³¨å†Œ    â”‚
        â”‚  - è‡ªåŠ¨è¿ç§»   â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â”‚  routes/           â”‚
                                      â”‚  auth_routes.go    â”‚
                                      â”‚  - è®¤è¯è·¯ç”±é…ç½®    â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚                     â”‚                     â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  handlers/     â”‚   â”‚  middleware/      â”‚  â”‚  models/     â”‚
                â”‚  auth_handlers â”‚   â”‚  auth_middleware  â”‚  â”‚  user.go     â”‚
                â”‚  - ä¸šåŠ¡é€»è¾‘    â”‚   â”‚  - è®¤è¯æ‹¦æˆª       â”‚  â”‚  - æ•°æ®æ¨¡å‹  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                     â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  util/           â”‚               â”‚  util/             â”‚
        â”‚  jwt_util.go     â”‚               â”‚  password_util.go  â”‚
        â”‚  - JWT ç”Ÿæˆ/éªŒè¯ â”‚               â”‚  - å¯†ç åŠ å¯†/éªŒè¯   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’» ä»£ç å®ç°ç»†èŠ‚

### 1. JWT Token ç”Ÿæˆï¼ˆutil/jwt_util.goï¼‰

```go
func GenerateToken(userID uint, expirationHours int) (string, error) {
  // æ­¥éª¤ 1: å‡†å¤‡æ•°æ®
  claims := Claims{
    UserID: userID,  // è‡ªå®šä¹‰å­—æ®µ
    RegisteredClaims: jwt.RegisteredClaims{
      ExpiresAt: jwt.NewNumericDate(time.Now().Add(time.Hour * time.Duration(expirationHours))),
      IssuedAt:  jwt.NewNumericDate(time.Now()),
    },
  }

  // æ­¥éª¤ 2: åˆ›å»ºæœªç­¾åçš„ Token
  // æ­¤æ—¶ Token åŒ…å« Header å’Œ Payloadï¼Œä½†è¿˜æ²¡æœ‰ Signature
  token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims)

  // æ­¥éª¤ 3: ç­¾å
  // è¿™ä¸€æ­¥ä¼šï¼š
  //   1. å°† Header å’Œ Payload Base64 ç¼–ç 
  //   2. ç”¨ HMAC-SHA256 è®¡ç®—ç­¾å
  //   3. æ‹¼æ¥æˆå®Œæ•´çš„ Token å­—ç¬¦ä¸²
  jwtSecret := os.Getenv("JWT_SECRET")
  tokenString, err := token.SignedString([]byte(jwtSecret))

  return tokenString, err
}
```

**åº•å±‚æ‰§è¡Œè¿‡ç¨‹**ï¼š

```
1. åˆ›å»º Header:
   {
     "alg": "HS256",
     "typ": "JWT"
   }
   
2. åˆ›å»º Payload:
   {
     "user_id": 123,
     "exp": 1704067200,
     "iat": 1704063600
   }

3. Base64 ç¼–ç :
   header_b64 = base64_url_encode(header_json)
   payload_b64 = base64_url_encode(payload_json)

4. è®¡ç®—ç­¾å:
   message = header_b64 + "." + payload_b64
   signature = HMAC_SHA256(message, secret_key)
   signature_b64 = base64_url_encode(signature)

5. æ‹¼æ¥:
   token = header_b64 + "." + payload_b64 + "." + signature_b64
```

### 2. JWT Token éªŒè¯ï¼ˆutil/jwt_util.goï¼‰

```go
func ParseToken(tokenString string) (*Claims, error) {
  jwtSecret := os.Getenv("JWT_SECRET")

  // jwt.ParseWithClaims ä¼šæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š
  token, err := jwt.ParseWithClaims(tokenString, &Claims{}, func(token *jwt.Token) (interface{}, error) {
    // éªŒè¯ç®—æ³•
    if _, ok := token.Method.(*jwt.SigningMethodHMAC); !ok {
      return nil, errors.New("æ— æ•ˆçš„ç­¾åç®—æ³•")
    }
    return []byte(jwtSecret), nil
  })

  if err != nil {
    return nil, err
  }

  // æå–å¹¶è¿”å› Claims
  if claims, ok := token.Claims.(*Claims); ok && token.Valid {
    return claims, nil
  }

  return nil, errors.New("æ— æ•ˆçš„ token")
}
```

**éªŒè¯è¿‡ç¨‹è¯¦è§£**ï¼š

```
1. åˆ†ç¦» Token:
   parts = token.split(".")
   header_b64 = parts[0]
   payload_b64 = parts[1]
   signature_b64 = parts[2]

2. è§£ç :
   header = base64_url_decode(header_b64)
   payload = base64_url_decode(payload_b64)
   signature = base64_url_decode(signature_b64)

3. é‡æ–°è®¡ç®—ç­¾å:
   message = header_b64 + "." + payload_b64
   computed_signature = HMAC_SHA256(message, secret_key)

4. æ¯”è¾ƒç­¾å:
   if computed_signature != signature:
       return "ç­¾åä¸åŒ¹é…ï¼ŒToken è¢«ç¯¡æ”¹"

5. æ£€æŸ¥è¿‡æœŸ:
   if current_time > payload.exp:
       return "Token å·²è¿‡æœŸ"

6. éªŒè¯é€šè¿‡:
   return payload
```

### 3. å¯†ç åŠ å¯†ï¼ˆutil/password_util.goï¼‰

```go
func HashPassword(password string) (string, error) {
  // bcrypt.GenerateFromPassword æ‰§è¡Œ:
  //   1. ç”Ÿæˆéšæœºç› (128 bits)
  //   2. å°†å¯†ç å’Œç›æ··åˆ
  //   3. æ‰§è¡Œ 2^cost æ¬¡ Blowfish åŠ å¯†
  //   4. è¿”å›æ ¼å¼: $2a$cost$salt$hash
  bytes, err := bcrypt.GenerateFromPassword([]byte(password), 10)
  return string(bytes), err
}

func CheckPassword(password, hash string) bool {
  // bcrypt.CompareHashAndPassword æ‰§è¡Œ:
  //   1. ä» hash ä¸­æå– salt
  //   2. ç”¨ç›¸åŒçš„ salt å¯¹ password åŠ å¯†
  //   3. æ¯”è¾ƒä¸¤ä¸ª hash æ˜¯å¦ç›¸åŒ
  err := bcrypt.CompareHashAndPassword([]byte(hash), []byte(password))
  return err == nil
}
```

### 4. è®¤è¯ä¸­é—´ä»¶ï¼ˆmiddleware/auth_middleware.goï¼‰

```go
func AuthMiddleware() gin.HandlerFunc {
  return func(c *gin.Context) {
    // 1. æå– Token
    token := extractToken(c)  // ä» Cookie æˆ– Header

    // 2. éªŒè¯ Token
    claims, err := util.ParseToken(token)
    if err != nil {
      c.JSON(401, gin.H{"error": "è®¤è¯å¤±è´¥"})
      c.Abort()  // ç»ˆæ­¢è¯·æ±‚ï¼Œä¸ç»§ç»­å¤„ç†
      return
    }

    // 3. å°†ç”¨æˆ·ä¿¡æ¯å­˜å…¥ä¸Šä¸‹æ–‡
    // Gin çš„ä¸Šä¸‹æ–‡æ˜¯è¯·æ±‚çº§åˆ«çš„ï¼Œåªåœ¨æœ¬æ¬¡è¯·æ±‚ä¸­æœ‰æ•ˆ
    c.Set("user_id", claims.UserID)

    // 4. ç»§ç»­å¤„ç†è¯·æ±‚
    c.Next()  // è°ƒç”¨ä¸‹ä¸€ä¸ª handler
  }
}
```

**ä¸­é—´ä»¶æ‰§è¡Œæµç¨‹**ï¼š

```
è¯·æ±‚åˆ°è¾¾
  â†“
[ä¸­é—´ä»¶ 1] AuthMiddleware
  â”œâ”€ æå– Token
  â”œâ”€ éªŒè¯ Token
  â”œâ”€ c.Set("user_id", xxx)
  â””â”€ c.Next() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â†“
                  [ä¸šåŠ¡ Handler] GetCurrentUser
                    â”œâ”€ userID := c.Get("user_id")
                    â”œâ”€ æŸ¥è¯¢æ•°æ®åº“
                    â””â”€ è¿”å›ç»“æœ
                        â”‚
                        â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è¿”å›
  â†“
è¿”å›å“åº”
```

---

## ğŸ›¡ï¸ å®‰å…¨æ€§ä¿éšœ

### 1. ä¸ºä»€ä¹ˆ JWT æ˜¯å®‰å…¨çš„ï¼Ÿ

#### åœºæ™¯ 1ï¼šæ”»å‡»è€…å°è¯•ä¿®æ”¹ user_id

```
åŸå§‹ Token:
eyJhbGc...  .  eyJ1c2VyX2lkIjoxMjMsImV4cCI6MTcwNH0  .  SflKxwRJ...
  Header          Payload (user_id=123)              Signature

æ”»å‡»è€…ä¿®æ”¹ Payload:
eyJhbGc...  .  eyJ1c2VyX2lkIjo5OTksImV4cCI6MTcwNH0  .  SflKxwRJ...
  Header          Payload (user_id=999)              æ—§çš„ Signature

æœåŠ¡ç«¯éªŒè¯:
computed_sig = HMAC_SHA256("Header.NewPayload", secret)
computed_sig â‰  SflKxwRJ... (æ—§ç­¾å)

ç»“æœ: âŒ éªŒè¯å¤±è´¥ï¼Œæ‹’ç»è¯·æ±‚
```

#### åœºæ™¯ 2ï¼šæ”»å‡»è€…å°è¯•é‡æ–°è®¡ç®—ç­¾å

```
æ”»å‡»è€…æƒ³è¦:
new_sig = HMAC_SHA256("Header.TamperedPayload", secret)

é—®é¢˜:
æ”»å‡»è€…ä¸çŸ¥é“ secret âŒ

å³ä½¿æ”»å‡»è€…çŸ¥é“ç®—æ³• (HMAC-SHA256)ï¼Œæ²¡æœ‰å¯†é’¥ä¹Ÿæ— æ³•è®¡ç®—æ­£ç¡®çš„ç­¾å
```

### 2. bcrypt é˜²æš´åŠ›ç ´è§£

```python
# å¸¸è§„ hash (MD5)
for password in password_list:
    if MD5(password) == target_hash:
        print(f"ç ´è§£æˆåŠŸ: {password}")
        break

# é€Ÿåº¦ï¼šæ¯ç§’å¯ä»¥æµ‹è¯•æ•°ç™¾ä¸‡ä¸ªå¯†ç 

# bcrypt (cost=10)
for password in password_list:
    if bcrypt(password, cost=10) == target_hash:
        print(f"ç ´è§£æˆåŠŸ: {password}")
        break

# é€Ÿåº¦ï¼šæ¯ç§’åªèƒ½æµ‹è¯•å‡ ç™¾ä¸ªå¯†ç  (æ…¢ 10000 å€ï¼)
# ç ´è§£ä¸€ä¸ªå¯†ç éœ€è¦æ•°å¹´ç”šè‡³æ•°åå¹´
```

### 3. å¤šå±‚é˜²æŠ¤

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 1 å±‚: HTTPS                        â”‚
â”‚  - åŠ å¯†ä¼ è¾“ï¼Œé˜²æ­¢ Token è¢«æˆªè·         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 2 å±‚: JWT ç­¾å                     â”‚
â”‚  - é˜²æ­¢ Token è¢«ç¯¡æ”¹                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 3 å±‚: Token è¿‡æœŸæ—¶é—´               â”‚
â”‚  - å³ä½¿ Token æ³„éœ²ï¼Œä¹Ÿåªåœ¨çŸ­æ—¶é—´å†…æœ‰æ•ˆ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 4 å±‚: bcrypt å¯†ç åŠ å¯†              â”‚
â”‚  - å³ä½¿æ•°æ®åº“æ³„éœ²ï¼Œå¯†ç ä¹Ÿæ— æ³•ç ´è§£      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”´ Redis è¿›é˜¶æ–¹æ¡ˆ

### ä¸ºä»€ä¹ˆéœ€è¦ Redisï¼Ÿ

JWT æ˜¯**æ— çŠ¶æ€çš„**ï¼ŒæœåŠ¡å™¨ä¸å­˜å‚¨ Tokenï¼Œè¿™å¸¦æ¥äº†ä¸€ä¸ªé—®é¢˜ï¼š

```
é—®é¢˜ 1: æ— æ³•ä¸»åŠ¨è®© Token å¤±æ•ˆ
ç”¨æˆ·ç™»å‡ºåï¼ŒToken ä¾ç„¶æœ‰æ•ˆï¼ˆç›´åˆ°è¿‡æœŸï¼‰

é—®é¢˜ 2: æ— æ³•å®ç°"è¸¢äºº"
ç®¡ç†å‘˜æƒ³å¼ºåˆ¶æŸç”¨æˆ·ä¸‹çº¿ï¼Œä½† Token è¿˜åœ¨å®¢æˆ·ç«¯

é—®é¢˜ 3: æ— æ³•é™åˆ¶å•ç‚¹ç™»å½•
ç”¨æˆ·å¯ä»¥åœ¨å¤šä¸ªè®¾å¤‡åŒæ—¶ç™»å½•
```

**è§£å†³æ–¹æ¡ˆï¼šå¼•å…¥ Redis**

### Redis é›†æˆæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                ç”¨æˆ·ç™»å½•                          â”‚
â”‚  1. éªŒè¯è´¦å·å¯†ç                                 â”‚
â”‚  2. ç”Ÿæˆ JWT Token                              â”‚
â”‚  3. å­˜å…¥ Redis                                  â”‚
â”‚     Key: user:token:{user_id}                   â”‚
â”‚     Value: token_string                         â”‚
â”‚     TTL: 24 hours                               â”‚
â”‚  4. è¿”å› Token                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              åç»­è¯·æ±‚éªŒè¯                        â”‚
â”‚  1. è§£æ JWT Tokenï¼Œæå– user_id               â”‚
â”‚  2. ä» Redis æŸ¥è¯¢: GET user:token:{user_id}    â”‚
â”‚  3. æ¯”è¾ƒ Redis ä¸­çš„ Token ä¸è¯·æ±‚ä¸­çš„ Token     â”‚
â”‚  4. éƒ½åŒ¹é… â†’ é€šè¿‡                               â”‚
â”‚     ä¸åŒ¹é… â†’ æ‹’ç»ï¼ˆToken å·²è¢«æ’¤é”€ï¼‰             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                è¸¢äººåŠŸèƒ½                          â”‚
â”‚  ç®¡ç†å‘˜æ“ä½œ:                                    â”‚
â”‚    DEL user:token:{target_user_id}              â”‚
â”‚                                                 â”‚
â”‚  æ•ˆæœ:                                          â”‚
â”‚    è¯¥ç”¨æˆ·ä¸‹æ¬¡è¯·æ±‚æ—¶ï¼ŒRedis ä¸­æ‰¾ä¸åˆ° Token       â”‚
â”‚    éªŒè¯å¤±è´¥ï¼Œå¼ºåˆ¶ä¸‹çº¿                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä»£ç å®ç°

#### 1. ç™»å½•æ—¶å­˜å…¥ Redis

```go
func Login(c *gin.Context) {
  // ... éªŒè¯è´¦å·å¯†ç  ...

  // ç”Ÿæˆ Token
  token, _ := util.GenerateToken(user.ID, 24)

  // å­˜å…¥ Redis
  redisKey := fmt.Sprintf("user:token:%d", user.ID)
  config.RedisClient.Set(
    context.Background(),
    redisKey,
    token,
    24 * time.Hour,  // ä¸ Token è¿‡æœŸæ—¶é—´ä¸€è‡´
  )

  // è¿”å› Token
  c.JSON(200, gin.H{"token": token})
}
```

#### 2. éªŒè¯æ—¶æ£€æŸ¥ Redis

```go
func AuthMiddleware() gin.HandlerFunc {
  return func(c *gin.Context) {
    token := extractToken(c)
    
    // è§£æ Tokenï¼ˆéªŒè¯ç­¾åå’Œè¿‡æœŸï¼‰
    claims, err := util.ParseToken(token)
    if err != nil {
      c.AbortWithStatus(401)
      return
    }

    // ä» Redis æ£€æŸ¥
    redisKey := fmt.Sprintf("user:token:%d", claims.UserID)
    storedToken, err := config.RedisClient.Get(context.Background(), redisKey).Result()

    if err != nil {
      // Redis ä¸­ä¸å­˜åœ¨ï¼Œè¯´æ˜å·²è¢«æ’¤é”€
      c.JSON(401, gin.H{"error": "Token å·²å¤±æ•ˆ"})
      c.Abort()
      return
    }

    if storedToken != token {
      // Token ä¸åŒ¹é…ï¼ˆå¯èƒ½æ˜¯æ—§ Tokenï¼‰
      c.JSON(401, gin.H{"error": "Token æ— æ•ˆ"})
      c.Abort()
      return
    }

    // éªŒè¯é€šè¿‡
    c.Set("user_id", claims.UserID)
    c.Next()
  }
}
```

#### 3. è¸¢äººæ¥å£

```go
func KickUser(c *gin.Context) {
  var req struct {
    UserID uint `json:"user_id"`
  }
  c.BindJSON(&req)

  // ä» Redis åˆ é™¤ Token
  redisKey := fmt.Sprintf("user:token:%d", req.UserID)
  config.RedisClient.Del(context.Background(), redisKey)

  c.JSON(200, gin.H{"message": "ç”¨æˆ·å·²è¢«è¸¢å‡º"})
}
```

### Redis æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|---------|
| **çº¯ JWT**ï¼ˆä¸ç”¨ Redisï¼‰ | å®Œå…¨æ— çŠ¶æ€<br>æ€§èƒ½æœ€é«˜<br>æ˜“æ‰©å±• | æ— æ³•ä¸»åŠ¨æ’¤é”€<br>æ— æ³•è¸¢äºº<br>æ— æ³•å•ç‚¹ç™»å½• | ä½å®‰å…¨è¦æ±‚<br>ç”¨æˆ·é‡å¤§<br>ä¸éœ€è¦è¸¢äººåŠŸèƒ½ |
| **JWT + Redis** | å¯ä»¥è¸¢äºº<br>å¯ä»¥å•ç‚¹ç™»å½•<br>å¯ä»¥æ’¤é”€ Token | éœ€è¦ç»´æŠ¤ Redis<br>æ¯æ¬¡è¯·æ±‚éƒ½æŸ¥ Redis<br>æ€§èƒ½ç•¥é™ | é«˜å®‰å…¨è¦æ±‚<br>éœ€è¦ç®¡ç†å‘˜åŠŸèƒ½<br>éœ€è¦å•ç‚¹ç™»å½• |
| **çº¯ Session** | å®Œå…¨å¯æ§<br>å¯ä»¥éšæ—¶æ’¤é”€ | éœ€è¦æœåŠ¡å™¨å­˜å‚¨<br>åˆ†å¸ƒå¼å¤æ‚<br>æ€§èƒ½è¾ƒä½ | å•ä½“åº”ç”¨<br>ç”¨æˆ·é‡å° |

---

## ğŸ“Š æ€»ç»“å¯¹æ¯”è¡¨

### è®¤è¯æ–¹å¼å¯¹æ¯”

| ç‰¹æ€§ | Session | JWT | JWT + Redis |
|------|---------|-----|-------------|
| **æœåŠ¡å™¨å­˜å‚¨** | âœ… éœ€è¦ | âŒ ä¸éœ€è¦ | âœ… éœ€è¦ï¼ˆRedisï¼‰ |
| **æ€§èƒ½** | ä¸­ç­‰ | é«˜ | ä¸­ç­‰ |
| **å¯æ‰©å±•æ€§** | éš¾ | æ˜“ | ä¸­ç­‰ |
| **å¯æ’¤é”€** | âœ… | âŒ | âœ… |
| **å•ç‚¹ç™»å½•** | âœ… | âŒ | âœ… |
| **å®ç°å¤æ‚åº¦** | ç®€å• | ç®€å• | ä¸­ç­‰ |

### å®‰å…¨æ€§å¯¹æ¯”

| æ–¹é¢ | æŠ€æœ¯ | å®‰å…¨ç­‰çº§ |
|------|------|---------|
| **å¯†ç å­˜å‚¨** | bcrypt (cost=10) | â­â­â­â­â­ |
| **Token ä¼ è¾“** | HTTPS | â­â­â­â­â­ |
| **Token é˜²ç¯¡æ”¹** | HMAC-SHA256 ç­¾å | â­â­â­â­â­ |
| **Token è¿‡æœŸ** | 24 å°æ—¶ | â­â­â­â­ |
| **ä¸»åŠ¨æ’¤é”€** | Redis | â­â­â­â­â­ |

---

## ğŸ¯ æ ¸å¿ƒè¦ç‚¹æ€»ç»“

1. **JWT çš„æœ¬è´¨**
   - ä¸€ä¸ªè¢«ç­¾åçš„ JSON æ•°æ®åŒ…
   - ä»»ä½•äººéƒ½èƒ½è§£ç æŸ¥çœ‹å†…å®¹ï¼Œä½†æ— æ³•ç¯¡æ”¹
   - æœåŠ¡å™¨é€šè¿‡ç­¾åéªŒè¯ Token çš„çœŸå®æ€§

2. **ç­¾åçš„ä½œç”¨**
   - ä½¿ç”¨ HMAC-SHA256 ç®—æ³•
   - éœ€è¦å¯†é’¥æ‰èƒ½ç”Ÿæˆ
   - ç¯¡æ”¹å†…å®¹ä¼šå¯¼è‡´ç­¾åä¸åŒ¹é…

3. **æ— çŠ¶æ€çš„ä¼˜åŠ¿**
   - æœåŠ¡å™¨ä¸éœ€è¦å­˜å‚¨ Session
   - å¤©ç„¶æ”¯æŒåˆ†å¸ƒå¼å’Œå¾®æœåŠ¡
   - éªŒè¯åªéœ€è®¡ç®—ç­¾åï¼Œæ— éœ€æŸ¥æ•°æ®åº“

4. **å¯†ç å®‰å…¨**
   - bcrypt è‡ªåŠ¨åŠ ç›ï¼Œç›¸åŒå¯†ç æ¯æ¬¡åŠ å¯†ç»“æœä¸åŒ
   - æ…¢å“ˆå¸Œç®—æ³•ï¼Œé˜²æ­¢æš´åŠ›ç ´è§£
   - å³ä½¿æ•°æ®åº“æ³„éœ²ï¼Œå¯†ç ä¹Ÿæ— æ³•åæ¨

5. **æ¨¡å—åä½œ**
   - è·¯ç”±å±‚ï¼šå®šä¹‰å“ªäº›æ¥å£éœ€è¦è®¤è¯
   - ä¸­é—´ä»¶å±‚ï¼šæ‹¦æˆªè¯·æ±‚ï¼ŒéªŒè¯ Token
   - å·¥å…·å±‚ï¼šæä¾› JWT å’Œå¯†ç å¤„ç†åŠŸèƒ½
   - Handler å±‚ï¼šå®ç°å…·ä½“ä¸šåŠ¡é€»è¾‘

6. **Redis çš„ä»·å€¼**
   - å¼¥è¡¥ JWT æ— çŠ¶æ€çš„ä¸è¶³
   - å®ç° Token æ’¤é”€å’Œè¸¢äººåŠŸèƒ½
   - é€‚åˆé«˜å®‰å…¨è¦æ±‚çš„åœºæ™¯

---

## ğŸ“š æ¨èé˜…è¯»

1. **JWT å®˜æ–¹è§„èŒƒ**: [RFC 7519](https://tools.ietf.org/html/rfc7519)
2. **bcrypt è®ºæ–‡**: [A Future-Adaptable Password Scheme](https://www.usenix.org/legacy/events/usenix99/provos/provos.pdf)
3. **HMAC è§„èŒƒ**: [RFC 2104](https://tools.ietf.org/html/rfc2104)
4. **OWASP è®¤è¯æŒ‡å—**: [Authentication Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html)

---

å¸Œæœ›è¿™ä»½è¯¦ç»†çš„è¯´æ˜èƒ½å¸®åŠ©ä½ æ·±å…¥ç†è§£ JWT è®¤è¯ç³»ç»Ÿçš„å®ç°æ€è·¯å’Œåº•å±‚é€»è¾‘ï¼ğŸ‰

